<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üîç RF Academy - Validador v13.1 FINAL - SINCRONIZADO 100% con Curriculum v13.1</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --primary: #2563eb;
            --success: #16a34a;
            --warning: #d97706;
            --error: #dc2626;
            --background: #f8fafc;
            --surface: #ffffff;
            --text: #1e293b;
            --text-muted: #64748b;
            --border: #e2e8f0;
            --border-strong: #cbd5e1;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: var(--background);
            color: var(--text);
            line-height: 1.6;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            text-align: center;
            margin-bottom: 40px;
            padding: 30px;
            background: linear-gradient(135deg, #16a34a 0%, #15803d 100%);
            color: white;
            border-radius: 16px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.1);
        }

        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
            font-weight: 700;
        }

        .header p {
            font-size: 1.2rem;
            opacity: 0.9;
        }

        .main-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
            margin-bottom: 30px;
        }

        .card {
            background: var(--surface);
            border-radius: 12px;
            padding: 25px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.05);
            border: 1px solid var(--border);
        }

        .card h2 {
            font-size: 1.5rem;
            margin-bottom: 20px;
            color: var(--primary);
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .upload-area {
            border: 2px dashed var(--border-strong);
            border-radius: 12px;
            padding: 40px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-bottom: 20px;
            user-select: none;
        }

        .upload-area:hover {
            border-color: var(--primary);
            background: rgba(37, 99, 235, 0.05);
        }

        .upload-area.dragover {
            border-color: var(--primary);
            background: rgba(37, 99, 235, 0.1);
        }

        .upload-icon {
            font-size: 3rem;
            margin-bottom: 15px;
            color: var(--text-muted);
        }

        #fileInput {
            display: none;
        }

        .textarea-container {
            margin-bottom: 20px;
        }

        #codeInput {
            width: 100%;
            height: 200px;
            padding: 15px;
            border: 1px solid var(--border);
            border-radius: 8px;
            font-family: 'Consolas', 'Monaco', monospace;
            font-size: 14px;
            resize: vertical;
            background: #f8f9fa;
        }

        .button-group {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .btn-primary {
            background: var(--primary);
            color: white;
        }

        .btn-primary:hover {
            background: #1d4ed8;
            transform: translateY(-1px);
        }

        .btn-secondary {
            background: var(--text-muted);
            color: white;
        }

        .btn-secondary:hover {
            background: #475569;
        }

        .validation-settings {
            display: flex;
            gap: 20px;
            margin-bottom: 20px;
            padding: 15px;
            background: #f1f5f9;
            border-radius: 8px;
        }

        .checkbox-group {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .results-section {
            grid-column: 1 / -1;
        }

        .results-container {
            display: none;
            margin-top: 20px;
        }

        .results-header {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-bottom: 20px;
            padding: 15px;
            border-radius: 8px;
        }

        .results-header.success {
            background: rgba(22, 163, 74, 0.1);
            color: var(--success);
            border: 1px solid rgba(22, 163, 74, 0.2);
        }

        .results-header.error {
            background: rgba(220, 38, 38, 0.1);
            color: var(--error);
            border: 1px solid rgba(220, 38, 38, 0.2);
        }

        .results-header.warning {
            background: rgba(217, 119, 6, 0.1);
            color: var(--warning);
            border: 1px solid rgba(217, 119, 6, 0.2);
        }

        .results-content {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }

        .validation-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px;
            border-radius: 6px;
            margin-bottom: 8px;
        }

        .validation-item.success {
            background: rgba(22, 163, 74, 0.05);
        }

        .validation-item.error {
            background: rgba(220, 38, 38, 0.05);
        }

        .validation-item.warning {
            background: rgba(217, 119, 6, 0.05);
        }

        .icon {
            font-size: 1.2rem;
        }

        .metrics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .metric-card {
            background: var(--surface);
            padding: 20px;
            border-radius: 8px;
            border: 1px solid var(--border);
            text-align: center;
        }

        .metric-value {
            font-size: 2rem;
            font-weight: 700;
            margin-bottom: 5px;
        }

        .metric-value.success { color: var(--success); }
        .metric-value.warning { color: var(--warning); }
        .metric-value.error { color: var(--error); }

        .metric-label {
            color: var(--text-muted);
            font-size: 0.9rem;
        }

        .detailed-results {
            margin-top: 20px;
        }

        .collapsible {
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: 8px;
            margin-bottom: 10px;
        }

        .collapsible-header {
            padding: 15px;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-weight: 600;
        }

        .collapsible-content {
            padding: 0 15px 15px;
            display: none;
            border-top: 1px solid var(--border);
        }

        .collapsible-content.active {
            display: block;
        }

        .prompt-aligned {
            background: linear-gradient(135deg, #16a34a 0%, #15803d 100%);
            color: white;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
        }

        .loading {
            display: none;
            text-align: center;
            padding: 20px;
        }

        .loading.active {
            display: block;
        }

        .spinner {
            border: 3px solid var(--border);
            border-top: 3px solid var(--primary);
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 15px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .stats-summary {
            background: linear-gradient(135deg, #16a34a 0%, #15803d 100%);
            color: white;
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 20px;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 20px;
            margin-top: 15px;
        }

        .stat-item {
            text-align: center;
        }

        .stat-number {
            font-size: 2rem;
            font-weight: 700;
            margin-bottom: 5px;
        }

        .stat-label {
            opacity: 0.9;
            font-size: 0.9rem;
        }

        .prompt-sync-alert {
            background: linear-gradient(135deg, #8b5cf6 0%, #a855f7 100%);
            color: white;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            text-align: center;
        }

        .sync-notice {
            background: linear-gradient(135deg, #059669 0%, #047857 100%);
            color: white;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            text-align: center;
        }

        /* Export Modal Styles */
        .export-modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.8);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 10000;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        .export-modal-content {
            background: white;
            padding: 30px;
            border-radius: 12px;
            max-width: 700px;
            width: 90%;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
            color: #1e293b;
            max-height: 90vh;
            overflow-y: auto;
        }

        .export-textarea {
            width: 100%;
            height: 80px;
            padding: 12px;
            border: 2px solid #e2e8f0;
            border-radius: 6px;
            font-family: 'Consolas', 'Monaco', monospace;
            font-size: 14px;
            resize: vertical;
            background: #f8f9fa;
        }

        .export-input {
            width: 100%;
            padding: 12px;
            border: 2px solid #e2e8f0;
            border-radius: 6px;
            font-size: 14px;
        }

        .export-btn {
            padding: 12px 20px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
            margin: 5px;
        }

        .export-btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        }

        .export-btn-success {
            background: var(--success);
            color: white;
        }

        .export-btn-primary {
            background: var(--primary);
            color: white;
        }

        .export-btn-secondary {
            background: var(--text-muted);
            color: white;
        }

        .error-list {
            list-style: none;
            padding: 0;
        }

        .error-item {
            background: rgba(220, 38, 38, 0.05);
            border: 1px solid rgba(220, 38, 38, 0.2);
            border-radius: 6px;
            padding: 12px;
            margin-bottom: 8px;
        }

        @media (max-width: 768px) {
            .main-grid {
                grid-template-columns: 1fr;
            }
            
            .results-content {
                grid-template-columns: 1fr;
            }
            
            .header h1 {
                font-size: 2rem;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üîç Robot Framework Academy</h1>
            <p>Validador v13.1 FINAL - SINCRONIZADO 100% con Curriculum v13.1 + Dashboard Export</p>
        </div>

        <!-- Sincronizaci√≥n Notice -->
        <div class="sync-notice">
            <h3>üéØ NUEVO: Validador v13.1 FINAL - 100% SINCRONIZADO con Curriculum-Data v13.1</h3>
            <p><strong>‚úÖ Umbrales actualizados:</strong> Comandos 20-45+, L√≠neas RF 30-85+, Variables 5-15+, Pr√°ctica 85-92%+</p>
            <p><strong>‚úÖ Prompt optimizado:</strong> "Generar lecci√≥n XXX usando curriculum-data.js y template simple"</p>
            <p><strong>‚úÖ Types sincronizados:</strong> Todas las 251 lecciones tienen type definido</p>
        </div>

        <div class="main-grid">
            <!-- Input Section -->
            <div class="card">
                <h2>üìÅ Cargar Lecci√≥n</h2>
                
                <div class="upload-area" id="uploadArea">
                    <div class="upload-icon">üìé</div>
                    <p><strong>Arrastra tu archivo .js aqu√≠</strong></p>
                    <p>o haz CLIC para seleccionar</p>
                </div>
                
                <input type="file" id="fileInput" accept=".js" />
                
                <div class="textarea-container">
                    <label for="codeInput">O pega el c√≥digo directamente:</label>
                    <textarea id="codeInput" placeholder="const LESSON_XXX = { ... }"></textarea>
                </div>

                <div class="validation-settings">
                    <div class="checkbox-group">
                        <input type="checkbox" id="strictMode">
                        <label for="strictMode">Modo estricto</label>
                    </div>
                    <div class="checkbox-group">
                        <input type="checkbox" id="promptUniversalMode" checked>
                        <label for="promptUniversalMode">Modo Prompt Universal</label>
                    </div>
                    <div class="checkbox-group">
                        <input type="checkbox" id="checkMetrics" checked>
                        <label for="checkMetrics">M√©tricas v13.1</label>
                    </div>
                    <div class="checkbox-group">
                        <input type="checkbox" id="curriculumSync" checked>
                        <label for="curriculumSync">Sync Curriculum v13.1</label>
                    </div>
                </div>

                <div class="button-group">
                    <button class="btn btn-primary" onclick="validateLesson()">
                        üîç Validar v13.1 FINAL
                    </button>
                    <button class="btn btn-secondary" onclick="clearResults()">
                        üóëÔ∏è Limpiar
                    </button>
                </div>
            </div>

            <!-- Quick Info Section -->
            <div class="card">
                <h2>üéØ Umbrales v13.1 FINAL - SINCRONIZADOS con Curriculum</h2>
                
                <div class="prompt-aligned">
                    <h3>‚ö° UMBRALES v13.1 ACTUALIZADOS (100% sincronizados):</h3>
                    <ul style="margin: 10px 0; padding-left: 20px;">
                        <li><strong>Comandos RF:</strong> 20-45+ (incrementados +5)</li>
                        <li><strong>L√≠neas RF:</strong> 30-85+ (incrementados +5)</li>
                        <li><strong>Variables RF:</strong> 5-15+ (seg√∫n metadatos v13.1)</li>
                        <li><strong>Pr√°ctica:</strong> 85-92%+ (incrementados +5%)</li>
                        <li><strong>Headers:</strong> ‚â§5 palabras (anti-teor√≠a)</li>
                        <li><strong>Content blocks:</strong> 4-6 flexibles (template simple)</li>
                    </ul>
                </div>

                <h3>üö® VALIDACIONES v13.1 FINAL:</h3>
                <ul style="margin: 15px 0; padding-left: 20px;">
                    <li><strong>AUTOEXTRAER:</strong> Validaci√≥n curriculum-data</li>
                    <li><strong>Type detection:</strong> 100% compatible</li>
                    <li><strong>RF Commands Enhanced:</strong> 45+ patrones</li>
                    <li><strong>Template simple:</strong> Directo al grano</li>
                    <li><strong>Espa√±ol nativo:</strong> Detecci√≥n autom√°tica</li>
                </ul>

                <h3>‚úÖ Tipos y duraciones sincronizadas:</h3>
                <ul style="margin: 15px 0; padding-left: 20px;">
                    <li><strong>5min standard:</strong> 90%+ pr√°ctica, 20+ comandos</li>
                    <li><strong>8min foundation:</strong> 90%+ pr√°ctica, 22+ comandos</li>
                    <li><strong>10min integration:</strong> 92%+ pr√°ctica, 25+ comandos</li>
                    <li><strong>15-25min capstone:</strong> 85%+ pr√°ctica, 45+ comandos</li>
                </ul>
            </div>
        </div>

        <!-- Loading -->
        <div class="loading" id="loading">
            <div class="spinner"></div>
            <p>Validando con umbrales v13.1 FINAL sincronizados...</p>
        </div>

        <!-- Results Section -->
        <div class="results-section">
            <div class="results-container" id="resultsContainer">
                <!-- Results will be inserted here -->
            </div>
        </div>
    </div>

    <script>
        // Global variables
        let currentLesson = null;
        let validationResults = null;
        let validationStartTime = null;

        // ============================================================================
        // üéØ UMBRALES v13.1 FINAL - 100% SINCRONIZADOS CON CURRICULUM-DATA v13.1
        // ============================================================================
        function getCurriculumSyncedThresholds(duration, title = '', level = 'beginner') {
            const minutes = parseInt(duration.match(/\d+/) || [10]);
            const tituloLower = title.toLowerCase();
            const isCurriculumSync = document.getElementById('curriculumSync').checked;
            const isPromptUniversal = document.getElementById('promptUniversalMode').checked;
            
            // ‚úÖ UMBRALES EXACTOS del curriculum-data.js v13.1
            const v131Metadata = {
                practiceRatios: {
                    'beginner-standard': 90,     // v13.1: incrementado +5%
                    'beginner-foundation': 90,   // v13.1: incrementado +5%
                    'beginner-integration': 92,  // v13.1: incrementado +2%
                    'beginner-capstone': 85,     // v13.1: incrementado +5%
                    'intermediate-standard': 85, // v13.1: incrementado +5%
                    'intermediate-integration': 90, // v13.1: incrementado +5%
                    'advanced-standard': 82,     // v13.1: incrementado +7%
                    'advanced-foundation': 82,   // v13.1: incrementado +7%
                    'advanced-capstone': 85      // v13.1: incrementado +5%
                },
                
                variableRequirements: {
                    'beginner-standard': 5,      // \\${VAR} escapadas
                    'beginner-foundation': 6,    // Foundation s√≥lida
                    'beginner-integration': 8,   // Integraci√≥n pr√°ctica
                    'beginner-capstone': 12,     // Proyecto comprehensivo
                    'intermediate-standard': 7,  // T√©cnicas intermedias
                    'intermediate-integration': 10, // Sistema integrado
                    'advanced-standard': 8,      // Enterprise patterns
                    'advanced-foundation': 10,   // Arquitectura enterprise
                    'advanced-capstone': 15      // M√°ximo para proyectos finales
                },
                
                rfLinesRequirements: {
                    'beginner-standard': 30,     // v13.1: incrementado +4
                    'beginner-foundation': 35,   // v13.1: incrementado +5
                    'beginner-integration': 40,  // v13.1: incrementado +5
                    'beginner-capstone': 85,     // v13.1: incrementado +5
                    'intermediate-standard': 45, // v13.1: incrementado +5
                    'intermediate-integration': 65, // v13.1: incrementado +5
                    'advanced-standard': 55,     // v13.1: incrementado +5
                    'advanced-foundation': 65,   // v13.1: incrementado +5
                    'advanced-capstone': 85      // v13.1: incrementado +5
                },
                
                commandsRequirements: {
                    'beginner-standard': 20,     // v13.1: incrementado +5
                    'beginner-foundation': 22,   // v13.1: incrementado +4
                    'beginner-integration': 25,  // v13.1: incrementado +5
                    'beginner-capstone': 45,     // v13.1: incrementado +5
                    'intermediate-standard': 25, // v13.1: incrementado +5
                    'intermediate-integration': 35, // v13.1: incrementado +5
                    'advanced-standard': 30,     // v13.1: incrementado +5
                    'advanced-foundation': 35,   // v13.1: incrementado +5
                    'advanced-capstone': 45      // v13.1: incrementado +5
                }
            };

            // Detectar tipo autom√°ticamente
            const esFoundation = tituloLower.includes('introducci√≥n') ||
                                tituloLower.includes('fundamentos') ||
                                tituloLower.includes('instalaci√≥n') ||
                                tituloLower.includes('setup') ||
                                tituloLower.includes('configuraci√≥n');
            
            const esIntegration = tituloLower.includes('proyecto') ||
                                 tituloLower.includes('ejercicio') ||
                                 tituloLower.includes('completo') ||
                                 tituloLower.includes('integrador');

            const esCapstone = tituloLower.includes('capstone') ||
                              tituloLower.includes('final') ||
                              minutes >= 20;

            // Determinar nivel y tipo
            let levelType = '';
            if (level === 'advanced') {
                if (esCapstone) levelType = 'advanced-capstone';
                else if (esFoundation) levelType = 'advanced-foundation';
                else levelType = 'advanced-standard';
            } else if (level === 'intermediate') {
                if (esIntegration) levelType = 'intermediate-integration';
                else levelType = 'intermediate-standard';
            } else { // beginner
                if (esCapstone) levelType = 'beginner-capstone';
                else if (esIntegration) levelType = 'beginner-integration';
                else if (esFoundation) levelType = 'beginner-foundation';
                else levelType = 'beginner-standard';
            }

            // ‚úÖ USAR EXACTAMENTE los umbrales del curriculum v13.1
            const baseThresholds = {
                minContentBlocks: isPromptUniversal ? 4 : 6,
                requiredBlocks: ['intro', 'code-example', 'exercise', 'next-steps'],
                minRobotLines: v131Metadata.rfLinesRequirements[levelType],
                minCommands: v131Metadata.commandsRequirements[levelType],
                minVariables: v131Metadata.variableRequirements[levelType],
                practiceRatio: isCurriculumSync ? v131Metadata.practiceRatios[levelType] : (isPromptUniversal ? 80 : 90),
                maxHeaderWords: 5, // v13.1: reducido de 6
                expectedScore: isCurriculumSync ? v131Metadata.practiceRatios[levelType] : 85,
                name: `${minutes}min ${levelType.toUpperCase()} (v13.1 SYNC)`,
                level: levelType.toUpperCase(),
                syncedWithCurriculum: isCurriculumSync
            };

            return baseThresholds;
        }

        // ============================================================================
        // üìä FUNCI√ìN RATIO OPTIMIZADA PARA v13.1 FINAL
        // ============================================================================
        
        function calculatePracticeContentV131(content) {
            let practiceScore = 0;
            
            // ‚úÖ CONTENIDO PR√ÅCTICO optimizado v13.1:
            
            // C√≥digo Robot Framework ejecutable (peso alto)
            const robotCodeBlocks = (content.match(/<pre><code class="robot">/g) || []).length;
            practiceScore += robotCodeBlocks * 15; // INCREMENTADO para v13.1
            
            // Comandos bash/shell verificables (peso alto)
            const bashCodeBlocks = (content.match(/<pre><code class="bash">/g) || []).length;
            practiceScore += bashCodeBlocks * 12; // INCREMENTADO
            
            // Exercise steps con comandos (peso alto)
            const exerciseSteps = (content.match(/class="exercise-step"|üéØ|<h3>.*[Pp]r√°ctica|<h3>.*[Ee]jercicio/g) || []).length;
            practiceScore += exerciseSteps * 10; // INCREMENTADO
            
            // Quick examples y demos pr√°cticos
            const quickExamples = (content.match(/üíª|<h3>.*[Ee]jemplo|<pre><code/g) || []).length;
            practiceScore += quickExamples * 8; // INCREMENTADO
            
            // Validation blocks con comandos
            const validationBlocks = (content.match(/‚úÖ|class="validation"|Al final sabr√°s/g) || []).length;
            practiceScore += validationBlocks * 6; // INCREMENTADO
            
            // File creation commands (echo, cat, touch, mkdir)
            const fileCommands = (content.match(/echo\s+|cat\s+>|touch\s+|mkdir\s+|robot\s+|cd\s+/g) || []).length;
            practiceScore += fileCommands * 4; // INCREMENTADO
            
            return practiceScore;
        }
        
        function calculateTheoryContentV131(content) {
            let theoryScore = 0;
            
            // ‚ùå CONTENIDO TE√ìRICO reducido para v13.1:
            
            // Headers y t√≠tulos (necesarios pero minimizados)
            const headers = (content.match(/<h[1-6]>/g) || []).length;
            theoryScore += headers * 0.3; // M√ÅS REDUCIDO para v13.1
            
            // P√°rrafos explicativos (peso muy reducido)
            const paragraphs = content.match(/<p>(.*?)<\/p>/g) || [];
            paragraphs.forEach(p => {
                const text = p.replace(/<[^>]*>/g, '');
                if (text.length > 120) { // Solo p√°rrafos MUY largos penalizan
                    theoryScore += 1.5; // MUY REDUCIDO
                } else {
                    theoryScore += 0.2; // CASI CERO
                }
            });
            
            // Lists items explicativos (m√°s permisivo)
            const listItems = (content.match(/<li>/g) || []).length;
            theoryScore += listItems * 0.2; // MUY REDUCIDO
            
            return theoryScore;
        }

        // File upload handlers
        const uploadArea = document.getElementById('uploadArea');
        const fileInput = document.getElementById('fileInput');
        const codeInput = document.getElementById('codeInput');

        // Initialize event listeners
        function initializeEventListeners() {
            uploadArea.addEventListener('click', (e) => {
                e.preventDefault();
                e.stopPropagation();
                fileInput.click();
            });

            uploadArea.addEventListener('dragover', (e) => {
                e.preventDefault();
                e.stopPropagation();
                uploadArea.classList.add('dragover');
            });

            uploadArea.addEventListener('dragleave', (e) => {
                e.preventDefault();
                e.stopPropagation();
                uploadArea.classList.remove('dragover');
            });

            uploadArea.addEventListener('drop', (e) => {
                e.preventDefault();
                e.stopPropagation();
                uploadArea.classList.remove('dragover');
                
                const files = e.dataTransfer.files;
                if (files.length > 0) {
                    handleFile(files[0]);
                }
            });

            fileInput.addEventListener('change', (e) => {
                if (e.target.files.length > 0) {
                    handleFile(e.target.files[0]);
                }
            });
        }

        function handleFile(file) {
            if (!file.name.endsWith('.js')) {
                alert('Por favor selecciona un archivo JavaScript (.js)');
                return;
            }

            uploadArea.innerHTML = `
                <div class="upload-icon">üìÑ</div>
                <p><strong>Archivo cargado: ${file.name}</strong></p>
                <p>Leyendo contenido...</p>
            `;

            const reader = new FileReader();
            reader.onload = (e) => {
                codeInput.value = e.target.result;
                uploadArea.innerHTML = `
                    <div class="upload-icon">‚úÖ</div>
                    <p><strong>Archivo cargado: ${file.name}</strong></p>
                    <p>Listo para validar con umbrales v13.1 FINAL</p>
                `;
            };
            
            reader.onerror = (e) => {
                alert('Error al leer el archivo');
                resetUploadArea();
            };
            
            reader.readAsText(file);
        }

        function resetUploadArea() {
            uploadArea.innerHTML = `
                <div class="upload-icon">üìé</div>
                <p><strong>Arrastra tu archivo .js aqu√≠</strong></p>
                <p>o haz CLIC para seleccionar</p>
            `;
        }

        // Main validation function
        async function validateLesson() {
            const code = codeInput.value.trim();
            
            if (!code) {
                alert('Por favor proporciona el c√≥digo de la lecci√≥n');
                return;
            }

            validationStartTime = Date.now();
            showLoading(true);
            
            try {
                currentLesson = parseLesson(code);
                validationResults = await runValidations(currentLesson, code);
                displayResults(validationResults);
            } catch (error) {
                displayError('Error al validar la lecci√≥n: ' + error.message);
            }
            
            showLoading(false);
        }

        function parseLesson(code) {
            try {
                const cleanCode = code.replace(/\/\*[\s\S]*?\*\//g, '').replace(/\/\/.*$/gm, '');
                
                const lessonMatch = cleanCode.match(/const\s+(LESSON_\d+)\s*=\s*({[\s\S]*?});?\s*(?=if\s*\(|$)/);
                if (!lessonMatch) {
                    throw new Error('No se encontr√≥ definici√≥n de lecci√≥n v√°lida (const LESSON_XXX = {...};)');
                }

                const lessonName = lessonMatch[1];
                const lessonObjectStr = lessonMatch[2];

                const idMatch = lessonName.match(/LESSON_(\d+)/);
                const expectedId = idMatch ? parseInt(idMatch[1]) : null;

                let lessonObj;
                try {
                    const safeEval = new Function('return ' + lessonObjectStr);
                    lessonObj = safeEval();
                } catch (evalError) {
                    throw new Error('Error de sintaxis en el objeto de la lecci√≥n: ' + evalError.message);
                }

                return {
                    raw: code,
                    name: lessonName,
                    expectedId,
                    object: lessonObj,
                    cleanCode
                };

            } catch (error) {
                throw new Error('Error al parsear la lecci√≥n: ' + error.message);
            }
        }

        async function runValidations(lesson, rawCode) {
            const results = {
                overall: 'success',
                score: 0,
                maxScore: 0,
                sections: {},
                metrics: {},
                errors: [],
                warnings: []
            };

            // Get thresholds sincronizados con curriculum v13.1
            const thresholds = getCurriculumSyncedThresholds(
                lesson.object.duration || '8 min',
                lesson.object.title || '',
                lesson.object.level || 'beginner'
            );
            results.thresholds = thresholds;

            // 1. Syntax Validation (optimizada v13.1)
            results.sections.syntax = validateSyntaxV131(lesson, rawCode);
            
            // 2. Structure Validation (sincronizada v13.1)
            results.sections.structure = validateStructureV131(lesson, thresholds);
            
            // 3. Content Validation (actualizada v13.1)
            results.sections.content = validateContentV131(lesson, thresholds);
            
            // 4. Variables Validation (sincronizada v13.1)
            results.sections.variables = validateVariablesV131(lesson, rawCode, thresholds);
            
            // 5. Curriculum Integration (mejorada v13.1)
            results.sections.curriculum = validateCurriculumIntegrationV131(lesson);

            // 6. Enhanced Metrics
            if (document.getElementById('checkMetrics').checked) {
                results.sections.metrics = validateMetricsEnhanced(lesson);
            }

            calculateOverallScore(results);
            return results;
        }

        // ============================================================================
        // üîß VALIDACIONES v13.1 FINAL - SINCRONIZADAS CON CURRICULUM
        // ============================================================================
        
        function validateSyntaxV131(lesson, rawCode) {
            const result = {
                name: 'Sintaxis JavaScript (v13.1 FINAL)',
                status: 'success',
                checks: [],
                score: 0,
                maxScore: 40
            };

            // Variables RF (detecci√≥n mejorada v13.1)
            const correctlyEscapedVars = [...rawCode.matchAll(/\\\\\\\\\$\{[^}]+\}/g)];
            const simpleVars = [...rawCode.matchAll(/\$\{[^}]+\}/g)].filter(v => !rawCode.substring(Math.max(0, v.index - 4), v.index).includes('\\\\\\\\'));

            if (correctlyEscapedVars.length > 0) {
                result.checks.push({
                    name: 'Variables Robot Framework',
                    status: 'success',
                    message: `${correctlyEscapedVars.length} variables RF correctamente escapadas`
                });
                result.score += 15;
            } else if (simpleVars.length > 0) {
                result.checks.push({
                    name: 'Variables Robot Framework',
                    status: 'warning',
                    message: `${simpleVars.length} variables detectadas (escape mejorable)`,
                    details: 'v13.1: Usar \\\\\\\\${VAR} para compatibilidad'
                });
                result.score += 12;
            } else {
                result.checks.push({
                    name: 'Variables Robot Framework',
                    status: 'warning',
                    message: 'No se encontraron variables RF',
                    details: 'Template simple v13.1 puede no requerirlas'
                });
                result.score += 10;
            }

            // Sintaxis JavaScript v√°lida
            if (rawCode.match(/};\s*$/m)) {
                result.checks.push({
                    name: 'Sintaxis JavaScript',
                    status: 'success',
                    message: 'Sintaxis JavaScript perfecta'
                });
                result.score += 15;
            } else {
                result.checks.push({
                    name: 'Sintaxis JavaScript',
                    status: 'warning',
                    message: 'Sintaxis v√°lida (mejorable)'
                });
                result.score += 12;
            }

            // Template string v√°lido
            if (rawCode.match(/content:\s*`([\s\S]*?)`/)) {
                result.checks.push({
                    name: 'Content template',
                    status: 'success',
                    message: 'Template string v√°lido v13.1'
                });
                result.score += 10;
            } else {
                result.checks.push({
                    name: 'Content template',
                    status: 'warning',
                    message: 'Template detectado (verificar formato)'
                });
                result.score += 8;
            }

            return result;
        }

        function validateStructureV131(lesson, thresholds) {
            const result = {
                name: `Estructura ${thresholds.level} (v13.1 SYNC)`,
                status: 'success',
                checks: [],
                score: 0,
                maxScore: 60
            };

            const obj = lesson.object;

            // Required properties (esenciales v13.1)
            const requiredProps = ['id', 'title', 'duration', 'content'];
            const missingProps = requiredProps.filter(prop => !(prop in obj));

            if (missingProps.length === 0) {
                result.checks.push({
                    name: 'Propiedades esenciales v13.1',
                    status: 'success',
                    message: 'Propiedades AUTOEXTRAER presentes'
                });
                result.score += 20;
            } else {
                result.checks.push({
                    name: 'Propiedades esenciales v13.1',
                    status: 'error',
                    message: `Faltan: ${missingProps.join(', ')}`
                });
                result.status = 'error';
            }

            // Content blocks (flexibles v13.1)
            const content = obj.content || '';
            const hasIntro = content.includes('Concepto') || content.includes('<h2>') || content.includes('üß†');
            const hasExample = content.includes('Ejemplo') || content.includes('<pre><code') || content.includes('üíª');
            const hasExercise = content.includes('Pr√°ctica') || content.includes('üéØ') || content.includes('ejercicio');
            const hasNext = content.includes('Siguiente') || content.includes('üöÄ') || content.includes('pr√≥xima');

            const foundBlocks = [hasIntro, hasExample, hasExercise, hasNext].filter(Boolean).length;

            if (foundBlocks >= thresholds.minContentBlocks) {
                result.checks.push({
                    name: 'Content blocks v13.1',
                    status: 'success',
                    message: `${foundBlocks}/${thresholds.minContentBlocks}+ blocks (template simple OK)`
                });
                result.score += 25;
            } else {
                result.checks.push({
                    name: 'Content blocks v13.1',
                    status: 'warning',
                    message: `${foundBlocks}/${thresholds.minContentBlocks} blocks (m√≠nimo v13.1)`,
                    details: 'Template simple: Concepto, Ejemplo, Pr√°ctica, Siguiente'
                });
                result.score += Math.round((foundBlocks / thresholds.minContentBlocks) * 25);
            }

            // Headers ‚â§5 palabras (v13.1 anti-teor√≠a)
            const headers = content.match(/<h[1-6]>(.*?)<\/h[1-6]>/g) || [];
            const shortHeaders = headers.filter(header => {
                const text = header.replace(/<[^>]*>/g, '').replace(/[^\w\s]/g, '');
                const words = text.split(/\s+/).filter(word => word.length > 0);
                return words.length <= thresholds.maxHeaderWords;
            });

            if (shortHeaders.length === headers.length && headers.length > 0) {
                result.checks.push({
                    name: 'Headers anti-teor√≠a v13.1',
                    status: 'success',
                    message: `${headers.length} headers ‚â§${thresholds.maxHeaderWords} palabras (directo al grano)`
                });
                result.score += 15;
            } else {
                result.checks.push({
                    name: 'Headers anti-teor√≠a v13.1',
                    status: 'warning',
                    message: `${shortHeaders.length}/${headers.length} headers ‚â§${thresholds.maxHeaderWords} palabras`,
                    details: `v13.1: Headers directo al grano, eliminar teor√≠a`
                });
                result.score += Math.round((shortHeaders.length / Math.max(headers.length, 1)) * 15);
            }

            return result;
        }

        function validateContentV131(lesson, thresholds) {
            const result = {
                name: `Contenido ${thresholds.level} (v13.1 SYNC)`,
                status: 'success',
                checks: [],
                score: 0,
                maxScore: 80
            };

            const content = lesson.object.content || '';

            // Robot Framework lines (seg√∫n curriculum v13.1)
            const robotCodeMatches = content.match(/<pre><code class="robot">([\s\S]*?)<\/code><\/pre>/g);
            let totalRobotLines = 0;
            
            if (robotCodeMatches) {
                robotCodeMatches.forEach(match => {
                    const codeContent = match.replace(/<[^>]*>/g, '');
                    totalRobotLines += codeContent.split('\n').filter(line => line.trim().length > 0).length;
                });
            }

            if (totalRobotLines >= thresholds.minRobotLines) {
                result.checks.push({
                    name: 'L√≠neas RF (v13.1 SYNC)',
                    status: 'success',
                    message: `${totalRobotLines} l√≠neas RF (objetivo v13.1: ${thresholds.minRobotLines})`
                });
                result.score += 30;
            } else if (totalRobotLines >= (thresholds.minRobotLines * 0.8)) {
                result.checks.push({
                    name: 'L√≠neas RF (v13.1 SYNC)',
                    status: 'warning',
                    message: `${totalRobotLines} l√≠neas (v13.1 objetivo: ${thresholds.minRobotLines})`,
                    details: 'Sincronizado con curriculum-data v13.1'
                });
                result.score += 22;
            } else {
                result.checks.push({
                    name: 'L√≠neas RF (v13.1 SYNC)',
                    status: 'error',
                    message: `${totalRobotLines} l√≠neas (v13.1 m√≠nimo: ${thresholds.minRobotLines})`,
                    details: 'Umbrales incrementados +5 en v13.1'
                });
                result.status = 'error';
                result.score += 12;
            }

            // ‚úÖ Comandos RF Enhanced v13.1 - SINCRONIZADOS con curriculum
            const enhancedRFCommands = [
                // Comandos b√°sicos RF
                /Should Be Equal\s+/g, /Should Contain\s+/g, /Should Be True\s+/g,
                /Log\s+/g, /Set.*Variable\s+/g, /Create File\s+/g, /Remove File\s+/g,
                
                // Selenium/Web commands
                /Input Text\s+/g, /Click Button\s+/g, /Click Element\s+/g, /Click Link\s+/g,
                /Wait Until Page Contains\s+/g, /Page Should Contain\s+/g,
                /Element Should Be Visible\s+/g, /Element Should Contain\s+/g,
                /Open Browser\s+/g, /Close Browser\s+/g, /Go To\s+/g, /Go Back\s+/g,
                /Select From List\s+/g, /Maximize Browser Window\s+/g, /Set Selenium Speed\s+/g,
                /Scroll Element Into View\s+/g, /Switch Window\s+/g, /Handle Alert\s+/g,
                /Execute Javascript\s+/g, /Capture Screenshot\s+/g, /Get Text\s+/g,
                /Get Element Count\s+/g, /Wait Until Element Is Visible\s+/g,
                
                // Keywords de configuraci√≥n
                /\[Setup\]\s+/g, /\[Teardown\]\s+/g, /\[Documentation\]\s+/g, /\[Tags\]\s+/g,
                /Sleep\s+/g, /Fail\s+/g, /Pass Execution\s+/g, /Return From Keyword\s+/g,
                /Run Keyword\s+/g, /Run Keyword If\s+/g, /Set Test Variable\s+/g, /Set Global Variable\s+/g,
                
                // Comandos de terminal/sistema
                /robot\s+/g, /mkdir\s+/g, /ls\s+/g, /cd\s+/g, /echo\s+/g,
                /python\s+/g, /pip\s+/g, /code\s+/g, /which\s+/g, /git\s+/g,
                
                // Keywords personalizados comunes
                /Prepare Test Environment/g, /Clean Test Environment/g,
                /Open Browser and Navigate/g, /Login With Valid Credentials/g,
                /Verify Page Title/g, /Take Screenshot On Failure/g
            ];

            let totalCommands = 0;
            enhancedRFCommands.forEach(pattern => {
                const matches = content.match(pattern);
                if (matches) totalCommands += matches.length;
            });

            if (totalCommands >= thresholds.minCommands) {
                result.checks.push({
                    name: 'Comandos RF Enhanced (v13.1 SYNC)',
                    status: 'success',
                    message: `${totalCommands} comandos RF (objetivo v13.1: ${thresholds.minCommands})`
                });
                result.score += 25;
            } else if (totalCommands >= (thresholds.minCommands * 0.8)) {
                result.checks.push({
                    name: 'Comandos RF Enhanced (v13.1 SYNC)',
                    status: 'warning',
                    message: `${totalCommands} comandos (v13.1 objetivo: ${thresholds.minCommands})`,
                    details: 'Enhanced: 45+ patrones RF + Web + Sistema'
                });
                result.score += 20;
            } else {
                result.checks.push({
                    name: 'Comandos RF Enhanced (v13.1 SYNC)',
                    status: 'warning',
                    message: `${totalCommands} comandos (v13.1 m√≠nimo: ${thresholds.minCommands})`,
                    details: 'Comandos incrementados +5 en curriculum v13.1'
                });
                result.score += 15;
            }

            // Ratio pr√°ctica/teor√≠a (sincronizado v13.1)
            const practiceContent = calculatePracticeContentV131(content);
            const theoryContent = calculateTheoryContentV131(content);
            
            const totalContent = practiceContent + theoryContent;
            const practiceRatio = totalContent > 0 ? (practiceContent / totalContent) * 100 : 0;

            if (practiceRatio >= thresholds.practiceRatio) {
                result.checks.push({
                    name: 'Ratio pr√°ctica v13.1 SYNC',
                    status: 'success',
                    message: `${Math.round(practiceRatio)}% pr√°ctica (v13.1: ${thresholds.practiceRatio}%+)`
                });
                result.score += 25;
            } else if (practiceRatio >= (thresholds.practiceRatio - 10)) {
                result.checks.push({
                    name: 'Ratio pr√°ctica v13.1 SYNC',
                    status: 'warning',
                    message: `${Math.round(practiceRatio)}% pr√°ctica (v13.1 objetivo: ${thresholds.practiceRatio}%+)`,
                    details: 'Ratios incrementados +5% en curriculum v13.1'
                });
                result.score += 20;
            } else {
                result.checks.push({
                    name: 'Ratio pr√°ctica v13.1 SYNC',
                    status: 'error',
                    message: `${Math.round(practiceRatio)}% pr√°ctica (v13.1 m√≠nimo: ${thresholds.practiceRatio}%+)`,
                    details: 'Template simple v13.1: directo al grano, m√°s pr√°ctica'
                });
                result.status = 'error';
                result.score += 12;
            }

            return result;
        }

        function validateVariablesV131(lesson, rawCode, thresholds) {
            const result = {
                name: 'Variables RF (v13.1 SYNC)',
                status: 'success',
                checks: [],
                score: 0,
                maxScore: 30
            };

            // Variables RF (seg√∫n metadatos v13.1)
            const correctVars = [...rawCode.matchAll(/\\\\\\\\\$\{[^}]+\}/g)];
            const simpleVars = [...rawCode.matchAll(/\$\{[^}]+\}/g)];
            const totalVars = correctVars.length + simpleVars.length;

            if (correctVars.length >= thresholds.minVariables) {
                result.checks.push({
                    name: 'Variables RF v13.1',
                    status: 'success',
                    message: `${correctVars.length} variables RF (v13.1 objetivo: ${thresholds.minVariables})`
                });
                result.score += 20;
            } else if (totalVars >= thresholds.minVariables) {
                result.checks.push({
                    name: 'Variables RF v13.1',
                    status: 'warning',
                    message: `${totalVars} variables RF (escape mejorable)`,
                    details: 'v13.1: Usar \\\\\\\\${VAR} format'
                });
                result.score += 16;
            } else if (totalVars > 0) {
                result.checks.push({
                    name: 'Variables RF v13.1',
                    status: 'warning',
                    message: `${totalVars} variables RF (v13.1 objetivo: ${thresholds.minVariables})`,
                    details: 'Variables incrementadas seg√∫n metadatos v13.1'
                });
                result.score += 12;
            } else {
                result.checks.push({
                    name: 'Variables RF v13.1',
                    status: 'warning',
                    message: 'Variables RF no detectadas',
                    details: 'Template simple puede tener menos variables'
                });
                result.score += 10;
            }

            // Type detection v13.1
            const hasValidType = lesson.object.type && ['standard', 'foundation', 'integration', 'capstone'].includes(lesson.object.type);
            if (hasValidType) {
                result.checks.push({
                    name: 'Type detection v13.1',
                    status: 'success',
                    message: `Type '${lesson.object.type}' detectado (curriculum v13.1 sync)`
                });
                result.score += 10;
            } else {
                result.checks.push({
                    name: 'Type detection v13.1',
                    status: 'warning',
                    message: 'Type no detectado o inv√°lido'
                });
                result.score += 5;
            }

            return result;
        }

        function validateCurriculumIntegrationV131(lesson) {
            const result = {
                name: 'Integraci√≥n Curriculum v13.1',
                status: 'success',
                checks: [],
                score: 0,
                maxScore: 25
            };

            const obj = lesson.object;

            // Verificar AUTOEXTRAER de curriculum-data v13.1
            const hasValidId = obj.id && obj.id >= 1 && obj.id <= 251;
            const hasValidTitle = obj.title && obj.title.length > 5;
            const hasValidDuration = obj.duration && obj.duration.includes('min');
            const hasValidLevel = obj.level && ['beginner', 'intermediate', 'advanced'].includes(obj.level);

            if (hasValidId && hasValidTitle && hasValidDuration && hasValidLevel) {
                result.checks.push({
                    name: 'AUTOEXTRAER v13.1',
                    status: 'success',
                    message: 'Datos auto-extra√≠dos de curriculum-data v13.1'
                });
                result.score += 15;
            } else {
                result.checks.push({
                    name: 'AUTOEXTRAER v13.1',
                    status: 'warning',
                    message: 'Verificar auto-extracci√≥n curriculum-data v13.1'
                });
                result.score += 10;
            }

            // Verificar idioma espa√±ol nativo
            const content = obj.content || '';
            const spanishWords = ['pr√°ctica', 'ejemplo', 'concepto', 'siguiente', 'robot', 'framework', 'comandos', 'variables'];
            const spanishCount = spanishWords.filter(word => content.toLowerCase().includes(word)).length;

            if (spanishCount >= 4) {
                result.checks.push({
                    name: 'Espa√±ol nativo v13.1',
                    status: 'success',
                    message: `Contenido en espa√±ol detectado (${spanishCount}/8 palabras)`
                });
                result.score += 10;
            } else {
                result.checks.push({
                    name: 'Espa√±ol nativo v13.1',
                    status: 'warning',
                    message: `Verificar espa√±ol nativo (${spanishCount}/8 palabras)`
                });
                result.score += 6;
            }

            return result;
        }

        function validateMetricsEnhanced(lesson) {
            const result = {
                name: 'M√©tricas Enhanced v13.1',
                status: 'success',
                checks: [],
                score: 0,
                maxScore: 30
            };

            const obj = lesson.object;
            const content = obj.content || '';

            // Duration vs content enhanced v13.1
            const duration = obj.duration || '';
            const estimatedMinutes = parseInt(duration.match(/\d+/) || [0]);
            
            const contentComplexity = 
                (content.match(/<pre><code/g) || []).length * 2.5 +
                (content.match(/class="exercise-step"|üéØ/g) || []).length * 3.5 +
                (content.match(/class="validation"|‚úÖ/g) || []).length * 1.5 +
                (content.match(/üíª|üß†|üöÄ/g) || []).length * 0.8;

            const estimatedContentTime = Math.round(contentComplexity * 1.1);
            const timeDiff = Math.abs(estimatedMinutes - estimatedContentTime);
            
            if (timeDiff <= 3 || estimatedMinutes <= 5) {
                result.checks.push({
                    name: 'Duraci√≥n vs contenido v13.1',
                    status: 'success',
                    message: `Duraci√≥n balanceada v13.1: ${estimatedMinutes}min`
                });
                result.score += 15;
            } else {
                result.checks.push({
                    name: 'Duraci√≥n vs contenido v13.1',
                    status: 'warning',
                    message: `Duraci√≥n: ${estimatedMinutes}min, contenido: ${estimatedContentTime}min`
                });
                result.score += 10;
            }

            // Template simple compliance v13.1
            const isSimpleTemplate = content.includes('üß†') && content.includes('üíª') && content.includes('üéØ') && content.includes('üöÄ');
            if (isSimpleTemplate) {
                result.checks.push({
                    name: 'Template simple v13.1',
                    status: 'success',
                    message: 'Compatible con template simple v13.1'
                });
                result.score += 15;
            } else {
                result.checks.push({
                    name: 'Template simple v13.1',
                    status: 'warning',
                    message: 'Verificar estructura template simple'
                });
                result.score += 8;
            }

            return result;
        }

        function calculateOverallScore(results) {
            let totalScore = 0;
            let maxTotalScore = 0;

            Object.values(results.sections).forEach(section => {
                totalScore += section.score;
                maxTotalScore += section.maxScore;
            });

            results.score = totalScore;
            results.maxScore = maxTotalScore;
            
            const percentage = maxTotalScore > 0 ? (totalScore / maxTotalScore) * 100 : 0;
            const expectedScore = results.thresholds?.expectedScore || 85;
            
            if (percentage >= expectedScore) {
                results.overall = 'success';
            } else if (percentage >= (expectedScore - 15)) {
                results.overall = 'warning';
            } else {
                results.overall = 'error';
            }
        }

        function displayResults(results) {
            const container = document.getElementById('resultsContainer');
            container.style.display = 'block';

            const percentage = results.maxScore > 0 ? Math.round((results.score / results.maxScore) * 100) : 0;
            const lessonTitle = currentLesson.object.title || 'Lecci√≥n sin t√≠tulo';
            const lessonId = currentLesson.object.id || 'XXX';
            const thresholds = results.thresholds || { name: 'Est√°ndar', expectedScore: 85 };

            const expectedScore = thresholds.expectedScore;
            const meetsExpectation = percentage >= expectedScore;
            const isCurriculumSync = document.getElementById('curriculumSync').checked;

            container.innerHTML = `
                <div class="results-header ${results.overall}">
                    <div class="icon">
                        ${results.overall === 'success' ? 'üü¢' : results.overall === 'warning' ? 'üü°' : 'üî¥'}
                    </div>
                    <div>
                        <h2>${meetsExpectation ? '‚úÖ PASSED v13.1' : 'üîß NEEDS IMPROVEMENT'}: Lecci√≥n ${String(lessonId).padStart(3, '0')} - ${lessonTitle}</h2>
                        <p>Score: ${percentage}% (v13.1 esperado: ${expectedScore}%+) - Formato: ${thresholds.name}</p>
                        <p><strong>v13.1 FINAL SYNC:</strong> ${isCurriculumSync ? '‚úÖ SINCRONIZADO' : 'üü° MODO UNIVERSAL'} con Curriculum-Data v13.1</p>
                    </div>
                </div>

                <div class="stats-summary">
                    <h3>üéØ Validaci√≥n v13.1 FINAL - SINCRONIZADO con Curriculum ${thresholds.level}</h3>
                    <div class="stats-grid">
                        <div class="stat-item">
                            <div class="stat-number">${percentage}%</div>
                            <div class="stat-label">Score v13.1</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-number">${expectedScore}%</div>
                            <div class="stat-label">Esperado v13.1</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-number">${thresholds.level}</div>
                            <div class="stat-label">Nivel Sincronizado</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-number">${Object.values(results.sections).filter(s => s.status === 'success').length}</div>
                            <div class="stat-label">Validaciones OK</div>
                        </div>
                    </div>
                </div>

                <div class="results-content">
                    <div class="detailed-results">
                        ${Object.entries(results.sections).map(([key, section]) => `
                            <div class="collapsible">
                                <div class="collapsible-header" onclick="toggleCollapsible(this)">
                                    <span>${section.status === 'success' ? '‚úÖ' : section.status === 'warning' ? '‚ö†Ô∏è' : '‚ùå'} ${section.name}</span>
                                    <span>${section.score}/${section.maxScore}</span>
                                </div>
                                <div class="collapsible-content">
                                    ${section.checks.map(check => `
                                        <div class="validation-item ${check.status}">
                                            <span class="icon">${check.status === 'success' ? '‚úÖ' : check.status === 'warning' ? '‚ö†Ô∏è' : '‚ùå'}</span>
                                            <div>
                                                <strong>${check.name}:</strong> ${check.message}
                                                ${check.details ? `<br><small style="color: var(--text-muted);">${check.details}</small>` : ''}
                                            </div>
                                        </div>
                                    `).join('')}
                                </div>
                            </div>
                        `).join('')}
                    </div>

                    <div class="metrics-grid">
                        ${generateMetricsV131(currentLesson, results)}
                    </div>
                </div>

                ${generateActionItemsV131(results)}
            `;

            // Auto-expand failed sections
            container.querySelectorAll('.collapsible').forEach(collapsible => {
                const header = collapsible.querySelector('.collapsible-header');
                const hasErrors = header.textContent.includes('‚ùå');
                if (hasErrors) {
                    toggleCollapsible(header);
                }
            });

            // Add export button
            setTimeout(addExportButton, 100);
        }

        function generateMetricsV131(lesson, results) {
            const obj = lesson.object;
            const content = obj.content || '';
            const thresholds = results.thresholds;

            const robotLines = (content.match(/<pre><code class="robot">([\s\S]*?)<\/code><\/pre>/g) || [])
                .reduce((acc, match) => {
                    const codeContent = match.replace(/<[^>]*>/g, '');
                    return acc + codeContent.split('\n').filter(line => line.trim().length > 0).length;
                }, 0);

            // Comandos Enhanced v13.1 sincronizados
            const enhancedCommandPatterns = [
                /Should Be Equal\s+/g, /Should Contain\s+/g, /Log\s+/g, /Set.*Variable\s+/g,
                /Input Text\s+/g, /Click Button\s+/g, /Wait Until Page Contains\s+/g,
                /Page Should Contain\s+/g, /Open Browser\s+/g, /Close Browser\s+/g,
                /robot\s+/g, /mkdir\s+/g, /echo\s+/g, /python\s+/g, /\[Setup\]\s+/g
            ];
            
            let commands = 0;
            enhancedCommandPatterns.forEach(pattern => {
                const matches = content.match(pattern);
                if (matches) commands += matches.length;
            });

            const variables = ([...content.matchAll(/\\\\\\\\\$\{[^}]+\}|\$\{[^}]+\}/g)] || []).length;
            const practiceRatio = Math.round(((content.match(/üíª|üéØ|<pre><code|ejemplo|pr√°ctica/gi) || []).length / Math.max((content.match(/<h[1-6]>|<p>/g) || []).length, 1)) * 100);

            return `
                <div class="metric-card">
                    <div class="metric-value ${robotLines >= thresholds.minRobotLines ? 'success' : robotLines >= (thresholds.minRobotLines * 0.8) ? 'warning' : 'error'}">${robotLines}</div>
                    <div class="metric-label">L√≠neas RF v13.1 (objetivo: ${thresholds.minRobotLines})</div>
                </div>
                <div class="metric-card">
                    <div class="metric-value ${commands >= thresholds.minCommands ? 'success' : commands >= (thresholds.minCommands * 0.8) ? 'warning' : 'error'}">${commands}</div>
                    <div class="metric-label">Comandos v13.1 (objetivo: ${thresholds.minCommands})</div>
                </div>
                <div class="metric-card">
                    <div class="metric-value ${variables >= thresholds.minVariables ? 'success' : variables > 0 ? 'warning' : 'error'}">${variables}</div>
                    <div class="metric-label">Variables v13.1 (objetivo: ${thresholds.minVariables})</div>
                </div>
                <div class="metric-card">
                    <div class="metric-value ${practiceRatio >= thresholds.practiceRatio ? 'success' : practiceRatio >= (thresholds.practiceRatio - 10) ? 'warning' : 'error'}">${practiceRatio}%</div>
                    <div class="metric-label">Pr√°ctica v13.1 (objetivo: ${thresholds.practiceRatio}%)</div>
                </div>
            `;
        }

        function generateActionItemsV131(results) {
            const errors = [];
            const warnings = [];

            Object.values(results.sections).forEach(section => {
                section.checks.forEach(check => {
                    if (check.status === 'error') {
                        errors.push(check);
                    } else if (check.status === 'warning') {
                        warnings.push(check);
                    }
                });
            });

            const expectedScore = results.thresholds?.expectedScore || 85;
            const currentScore = results.maxScore > 0 ? Math.round((results.score / results.maxScore) * 100) : 0;
            const isCurriculumSync = document.getElementById('curriculumSync').checked;

            if (errors.length === 0 && warnings.length <= 2 && currentScore >= expectedScore) {
                return `
                    <div class="card" style="margin-top: 20px; background: rgba(22, 163, 74, 0.05); border-color: var(--success);">
                        <h3 style="color: var(--success);">üéâ ¬°Lecci√≥n PERFECTA v13.1 FINAL!</h3>
                        <p>Score: ${currentScore}% (esperado: ${expectedScore}%+) - Formato: ${results.thresholds?.level}</p>
                        <p><strong>‚úÖ 100% Sincronizado con Curriculum v13.1 | ‚úÖ Template simple OK | ‚úÖ RF Commands Enhanced | ‚úÖ Lista para producci√≥n</strong></p>
                    </div>
                `;
            }

            return `
                <div class="card" style="margin-top: 20px;">
                    <h3>üîß Mejoras v13.1 FINAL - ${results.thresholds?.level}</h3>
                    <p><strong>Score actual:</strong> ${currentScore}% | <strong>v13.1 objetivo:</strong> ${expectedScore}%+ | <strong>Sync:</strong> ${isCurriculumSync ? 'CURRICULUM' : 'UNIVERSAL'}</p>
                    
                    ${errors.length > 0 ? `
                        <h4 style="color: var(--error); margin: 15px 0 10px;">‚ùå Errores cr√≠ticos v13.1:</h4>
                        <ul class="error-list">
                            ${errors.map(error => `
                                <li class="error-item">
                                    <strong>${error.name}:</strong> ${error.message}
                                    ${error.details ? `<br><small>${error.details}</small>` : ''}
                                </li>
                            `).join('')}
                        </ul>
                    ` : ''}
                    
                    ${warnings.length > 0 ? `
                        <h4 style="color: var(--warning); margin: 15px 0 10px;">‚ö†Ô∏è Optimizaciones v13.1:</h4>
                        <ul class="error-list">
                            ${warnings.slice(0, 3).map(warning => `
                                <li class="error-item" style="background: rgba(217, 119, 6, 0.05); border-color: var(--warning);">
                                    <strong>${warning.name}:</strong> ${warning.message}
                                    ${warning.details ? `<br><small>${warning.details}</small>` : ''}
                                </li>
                            `).join('')}
                        </ul>
                    ` : ''}
                    
                    <div style="margin-top: 15px; padding: 15px; background: rgba(5, 150, 105, 0.1); border-radius: 8px; border-left: 4px solid var(--success);">
                        <h4 style="color: var(--success);">üí° Prompt v13.1 FINAL optimizado:</h4>
                        <p style="background: white; padding: 10px; border-radius: 4px; font-family: monospace; margin: 10px 0;">
                            Generar lecci√≥n XXX usando curriculum-data.js y template simple.<br>
                            AUTOEXTRAER: t√≠tulo, duraci√≥n, nivel, section, topics, type autom√°ticamente.<br>
                            OPTIMIZAR: 85%+ pr√°ctica, headers ‚â§5 palabras, 20+ comandos RF verificables.<br>
                            REGLAS: Simple, espa√±ol, directo al grano, eliminar teor√≠a innecesaria.
                        </p>
                        <p>‚Ä¢ ‚úÖ Umbrales v13.1: sincronizados con curriculum-data metadatos</p>
                        <p>‚Ä¢ ‚úÖ RF Commands Enhanced: detecta 45+ tipos comandos</p>
                        <p>‚Ä¢ ‚úÖ Template simple: 4+ content blocks, headers ‚â§5 palabras</p>
                        <p>‚Ä¢ ‚úÖ Type detection: 100% compatible con 251 lecciones</p>
                    </div>
                </div>
            `;
        }

        function addExportButton() {
            const resultsContainer = document.getElementById('resultsContainer');
            if (resultsContainer && resultsContainer.style.display !== 'none') {
                const existingButton = document.getElementById('exportToDashboardBtn');
                if (!existingButton) {
                    const exportButton = document.createElement('button');
                    exportButton.id = 'exportToDashboardBtn';
                    exportButton.innerHTML = 'üìä Exportar a Dashboard v13.1 FINAL';
                    exportButton.className = 'btn btn-primary';
                    exportButton.style.cssText = `
                        margin: 20px auto;
                        display: block;
                        background: linear-gradient(135deg, #16a34a 0%, #15803d 100%);
                        border: none;
                        padding: 15px 30px;
                        font-size: 16px;
                        font-weight: 600;
                        border-radius: 8px;
                        cursor: pointer;
                        color: white;
                        transition: all 0.3s ease;
                        box-shadow: 0 4px 12px rgba(22, 163, 74, 0.25);
                    `;
                    
                    exportButton.onclick = () => {
                        alert('üìä Export v13.1 FINAL: Funcionalidad disponible en pr√≥xima versi√≥n del Dashboard');
                    };
                    
                    resultsContainer.appendChild(exportButton);
                }
            }
        }

        function toggleCollapsible(header) {
            const content = header.nextElementSibling;
            const isActive = content.classList.contains('active');
            
            content.classList.toggle('active', !isActive);
            
            const arrow = header.querySelector('.arrow') || document.createElement('span');
            if (!header.querySelector('.arrow')) {
                arrow.className = 'arrow';
                arrow.textContent = '‚ñº';
                header.appendChild(arrow);
            }
            arrow.textContent = isActive ? '‚ñº' : '‚ñ≤';
        }

        function displayError(message) {
            const container = document.getElementById('resultsContainer');
            container.style.display = 'block';
            container.innerHTML = `
                <div class="results-header error">
                    <div class="icon">üî¥</div>
                    <div>
                        <h2>ERROR v13.1: No se pudo validar la lecci√≥n</h2>
                        <p>${message}</p>
                    </div>
                </div>
            `;
        }

        function showLoading(show) {
            const loading = document.getElementById('loading');
            loading.classList.toggle('active', show);
        }

        function clearResults() {
            document.getElementById('codeInput').value = '';
            document.getElementById('resultsContainer').style.display = 'none';
            currentLesson = null;
            validationResults = null;
            validationStartTime = null;
            resetUploadArea();
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            console.log('üîç RF Academy Validador v13.1 FINAL - 100% SINCRONIZADO con Curriculum v13.1');
            console.log('‚ö° Umbrales v13.1: Comandos 20-45+, L√≠neas 30-85+, Variables 5-15+, Pr√°ctica 85-92%+');
            console.log('üéØ Compatible con prompt: "Generar lecci√≥n XXX usando curriculum-data.js y template simple"');
            console.log('ü§ñ RF Commands Enhanced: 45+ patrones sincronizados');
            console.log('‚úÖ Type detection: 100% compatible con 251 lecciones');
            console.log('üìä Export: Preparado para Dashboard v13.1 FINAL');
            initializeEventListeners();
        });
    </script>
</body>
</html>